<!--
Copyright 2017 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Animated Blur</title>
<style>

html {
  -webkit-text-size-adjust: none; /* Never autoresize text */
  -moz-text-size-adjust: none;
  -ms-text-size-adjust: none;
}

/*
body {
  background: 0 -100px repeat-x
  url(./images/bg_gallery.png) #4F191A;
}
*/

.bodyStyle {
  /*
  Necessary for Firefox
  */
  margin: 0;
  padding: 0;
  /*
  Necessary for all browers
  */
  min-width: -webkit-min-content;
  min-width: -moz-min-content;
  min-width: min-content;
}

.animated-blur {
  position: relative;
}

svg {
  position: absolute;
  display: block;
  margin: 0 auto;
  pointer-events: none;
}

.composited {
  will-change: transform;
}

.clonedElement {
  position: absolute;
  display: block;
  margin: 0 auto;
  pointer-events: none;
}

.selected {
  position: absolute;
  display: block;
  pointer-events: none;
}

.tooltip {
  padding: 10px;
  color: blue;
  pointer-events: none;
}

.lead {
  font-style: italic;
  color: purple;
}

.tooltip p{
  padding: 0;
  font-size: 18px;
}

polygon {
  pointer-events: none;
}

h1 {
  text-align: -moz-center;
  text-align: -webkit-center;
  text-align: -ms-center;
  font-size: 40px;
  /*Necessary due to cross-platform collapsing margin*/
  margin-top: 0px;
}

p {
  font-size: 35px;
}

table {
  margin: 0 auto;
}

td {
  padding: 20px;
}

figcaption {
  display: none;
}
</style>

<body>
  <div style='border: 5px solid blue; font-size: 38px; padding: 20px;'>
    This line and the following img won't be blurred.
  </div>
  <div>
    <img src="./images/bg_gallery.png" style='border: 5px solid red; width: 100%; height: 200px;'/>
  </div>
  <div class="animated-blur">
    <h1>Google products gallery</h1>
    <p>Browse a comprehensive list of Google products designed to help you work and play, stay organized, get answers, keep in touch, grow your business, and more.</p>
    <table>
      <tr>
        <td>
          <figure>
            <img src="./images/chrome.png" alt="Chrome"/>
            <figcaption>A fast, simple, and secure browser for the modern web.
            </figcaption>
          </figure>
        </td>
        <td>
          <figure>
            <img src="./images/youtube.png" alt="YouTube"/>
            <figcaption>Discover, watch, and share your favorite videos and music.
            </figcaption>
          </figure>
        </td>
        <td>
          <figure>
            <img src="./images/maps.png" alt="Maps"/>
            <figcaption>Get GPS navigation, traffic alerts, transit directions, and more.
            </figcaption>
          </figure>
        </td>
        <td>
          <figure>
            <img src="./images/translate.png" alt="Translate"/>
            <figcaption>Speak, scan, type, or draw to translate in over 100 languages.
            </figcaption>
          </figure>
        </td>
      </tr>
      <tr>
        <td>
          <figure>
            <img src="./images/search.png" alt="Search"/>
            <figcaption>Get instant answers on the web and on your phone.
            </figcaption>
          </figure>
        </td>
        <td>
          <figure>
            <img src="./images/android.png" alt="Android Phones"/>
            <figcaption>All kinds of devices for all kinds of folks.
            </figcaption>
          </figure>
        </td>
        <td>
          <figure>
            <img src="./images/gmail.png" alt="Gmail"/>
            <figcaption>Email by Google</figcaption>
          </figure>
        </td>
        <td>
          <figure>
            <img src="./images/photos.png" alt="Photos"/>
            <figcaption>All your photos, organized, and easy to find.
            </figcaption>
          </figure>
        </td>
      </tr>
    </table>
    <div style="height:1000px;"></div>
  </div>
</body>
<script src="scripts/animated_blur.js"></script>
<script>
  var blurredElement = document.querySelector('.animated-blur');
  var blurAnimation = new AnimatedBlur('view', blurredElement, {steps: 4, duration: 1000});
  blurAnimation.update();
  var mode = blurMode.STANDBY;
  var selectedImg = null;
  var animatedBlur = false;
  var currentBlurEvent = null;
  var currentTooltip = null;

  var svgns = "http://www.w3.org/2000/svg";
  var xhtmlns = "http://www.w3.org/1999/xhtml";

  createTooltipSVG();

  document.onclick = function(e) {
    if (!animatedBlur) {
      reset();
      if (e.target.localName == 'img') {
        mode = blurMode.BLUR;
        animatedBlur = true;
        currentBlurEvent = e;
      } else {
        mode = blurMode.STANDBY;
      }
    } else {
      mode *= -1;
      animatedBlur = false;
      currentBlurEvent = null;
    }
    blurAnimation.play(mode);
    displaySelectedImg();
    displayTooltip();
  }

  window.onresize = function() {
    blurAnimation.resize();
    if (!currentBlurEvent) return;
    var temporaries = document.body.querySelectorAll('.temporary');
    for (var i = 0; i < temporaries.length; ++i) {
      temporaries[i].style.left = currentBlurEvent.target.x + 'px';
      temporaries[i].style.top = currentBlurEvent.target.y + 'px';
    }
    if (currentTooltip) {
      document.getElementById('toolTip').remove();
      createTooltipSVG();
      displayTooltip(mode);
    }
  }

  function displaySelectedImg() {
    if (mode == blurMode.STANDBY) return;
    if (selectedImg) {
      selectedImg.style.animation = 'view-b1-anim 1s linear forwards';
      return;
    }
    selectedImg = currentBlurEvent.target.cloneNode(true);
    selectedImg.setAttribute('class', 'selected temporary composited');
    // target image in firefox doesn't have correct x and y?
    selectedImg.style.left = currentBlurEvent.target.x + 'px';
    selectedImg.style.top = currentBlurEvent.target.y + 'px';
    document.body.insertBefore(selectedImg,
        document.getElementById('toolTip'));
  }

  function reset() {
    if (selectedImg) {
      selectedImg.remove();
      selectedImg = null;
    }
    if (currentTooltip) {
      currentTooltip.remove();
      currentTooltip = null;
      document.getElementById('toolTip').style.animation = '';
    }
  }

  function createTooltipSVG() {
    var width = blurredElement.clientWidth;
    var height = blurredElement.clientHeight;

    var svg = document.createElementNS(svgns, 'svg');
    svg.id = 'toolTip';
    svg.style.top = blurredElement.offsetTop + 'px';
    svg.style.left = blurredElement.offsetLeft + 'px';
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);
    svg.setAttribute('class', 'composited');
    document.body.appendChild(svg);
  }

  function displayTooltip() {
    var svg = document.body.querySelector('#toolTip');
    if (mode == blurMode.UNBLUR) {
      svg.style.animation = 'view-b1-anim 1s linear forwards';
    }
    if (mode == blurMode.STANDBY || !currentBlurEvent) return;
    if (currentBlurEvent.target.nextElementSibling.localName != 'figcaption') return;
    var g = document.createElementNS(svgns, 'g');
    currentTooltip = g;
    svg.appendChild(g);
    var foWidth = 300;
    // TODO: Doesn't work with window resize
    var anchor = {'w': currentBlurEvent.layerX, 'h': currentBlurEvent.layerY};
    var t = 50, k = 15;
    var tip = {'w': (3/4 * t), 'h': k};
    var fo = document.createElementNS(svgns, 'foreignObject');
    var tooltipX = anchor.w - tip.w + foWidth > blurredElement.clientWidth ?
        blurredElement.clientWidth - foWidth - tip.w : anchor.w - tip.w;

    fo.setAttribute('x', tooltipX);
    fo.setAttribute('width', foWidth);
    fo.setAttribute('class', 'svg-tooltip');
    g.appendChild(fo);
    var div = document.createElementNS(xhtmlns, 'div');
    div.setAttribute('class', 'tooltip');
    fo.appendChild(div);
    var p = document.createElement('p');
    p.setAttribute('class', 'lead');
    p.innerHTML = currentBlurEvent.target.alt;
    div.appendChild(p);
    p = document.createElement('p');

    p.innerHTML = currentBlurEvent.target.nextElementSibling.innerText;
    div.appendChild(p);
    //TODO: getBoundingClientRect doesn't work properly in Firefox
    //var foHeight = div.getBoundingClientRect().height;
    var foHeight = 150;
    fo.setAttribute('height', foHeight);
    var tooltipY = anchor.h + tip.h + foHeight > blurredElement.clientHeight ?
    blurredElement.clientHeight - foHeight - tip.h : anchor.h + tip.h;
    fo.setAttribute('y', tooltipY);
    var polygon = document.createElementNS(svgns, 'polygon');
    polygon.setAttribute('points', "0,0 0," + foHeight + " " + foWidth +
        "," + foHeight + " " + foWidth + ",0 " + (t) + ",0 " + tip.w +
        "," + (-tip.h) + " " + (t/2) + ",0");
    polygon.setAttribute('height', foHeight + tip.h);
    polygon.style.height = foHeight + tip.h;
    polygon.setAttribute('width', foWidth);
    polygon.setAttribute('fill', '#D8D8D8');
    polygon.setAttribute('opacity', 0.75);
    polygon.setAttribute('transform', 'translate(' + tooltipX + ',' +
          tooltipY + ')');
    g.insertBefore(polygon, fo);
  }

</script>
</head>

</html>
